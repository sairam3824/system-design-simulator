{"version":3,"sources":["../../../../../../../Documents/Git/system-design/system-design-simulator/src/lib/cache.ts"],"sourcesContent":["/**\n * Cache Utilities\n *\n * Provides helpers for caching with Redis.\n * All operations gracefully fall back to direct execution if Redis is unavailable.\n */\n\nimport { getRedisClient, isRedisAvailable, CACHE_TTL } from \"./redis\";\n\n/**\n * Get a cached value by key\n */\nexport async function cacheGet<T>(key: string): Promise<T | null> {\n  if (!isRedisAvailable()) {\n    return null;\n  }\n\n  try {\n    const redis = getRedisClient();\n    if (!redis) return null;\n\n    const value = await redis.get(key);\n    return value as T | null;\n  } catch (error) {\n    console.error(\"Cache get error:\", error);\n    return null;\n  }\n}\n\n/**\n * Set a cached value with TTL\n */\nexport async function cacheSet<T>(\n  key: string,\n  value: T,\n  ttlSeconds: number = CACHE_TTL.USER_ANALYTICS\n): Promise<boolean> {\n  if (!isRedisAvailable()) {\n    return false;\n  }\n\n  try {\n    const redis = getRedisClient();\n    if (!redis) return false;\n\n    await redis.set(key, JSON.stringify(value), { ex: ttlSeconds });\n    return true;\n  } catch (error) {\n    console.error(\"Cache set error:\", error);\n    return false;\n  }\n}\n\n/**\n * Delete a cached value\n */\nexport async function cacheDelete(key: string): Promise<boolean> {\n  if (!isRedisAvailable()) {\n    return false;\n  }\n\n  try {\n    const redis = getRedisClient();\n    if (!redis) return false;\n\n    await redis.del(key);\n    return true;\n  } catch (error) {\n    console.error(\"Cache delete error:\", error);\n    return false;\n  }\n}\n\n/**\n * Delete multiple cached values by pattern\n */\nexport async function cacheDeletePattern(pattern: string): Promise<boolean> {\n  if (!isRedisAvailable()) {\n    return false;\n  }\n\n  try {\n    const redis = getRedisClient();\n    if (!redis) return false;\n\n    // Upstash Redis supports SCAN for pattern matching\n    let cursor = 0;\n    do {\n      const [newCursor, keys] = await redis.scan(cursor, {\n        match: pattern,\n        count: 100,\n      });\n      cursor = parseInt(newCursor as string, 10);\n\n      if (keys.length > 0) {\n        await redis.del(...keys);\n      }\n    } while (cursor !== 0);\n\n    return true;\n  } catch (error) {\n    console.error(\"Cache delete pattern error:\", error);\n    return false;\n  }\n}\n\n/**\n * Get or fetch pattern - returns cached value or fetches and caches it\n */\nexport async function getOrFetch<T>(\n  key: string,\n  fetcher: () => Promise<T>,\n  ttlSeconds: number = CACHE_TTL.USER_ANALYTICS\n): Promise<T> {\n  // Try to get from cache first\n  const cached = await cacheGet<T>(key);\n  if (cached !== null) {\n    // Parse if it's a string (JSON)\n    if (typeof cached === \"string\") {\n      try {\n        return JSON.parse(cached) as T;\n      } catch {\n        return cached as T;\n      }\n    }\n    return cached;\n  }\n\n  // Fetch fresh data\n  const fresh = await fetcher();\n\n  // Cache the result\n  await cacheSet(key, fresh, ttlSeconds);\n\n  return fresh;\n}\n\n/**\n * Invalidate user analytics cache\n */\nexport async function invalidateUserAnalytics(userId: string): Promise<void> {\n  await cacheDeletePattern(`analytics:user:${userId}*`);\n}\n\n/**\n * Invalidate leaderboard cache\n */\nexport async function invalidateLeaderboard(): Promise<void> {\n  await cacheDeletePattern(\"leaderboard:*\");\n}\n"],"names":[],"mappings":"uCAOA,IAAA,EAAA,EAAA,CAAA,CAAA,OAKO,eAAe,EAAY,CAAW,EAC3C,GAAI,CAAC,CAAA,EAAA,EAAA,gBAAA,AAAgB,IACnB,CADuB,MAChB,KAGT,GAAI,CACF,IAAM,EAAQ,CAAA,EAAA,EAAA,cAAc,AAAd,IACd,GAAI,CAAC,EAAO,OAAO,KAGnB,OADc,AACP,MADa,EAAM,GAAG,CAAC,EAEhC,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,mBAAoB,GAC3B,IACT,CACF,CAKO,eAAe,EACpB,CAAW,CACX,CAAQ,CACR,EAAqB,EAAA,SAAS,CAAC,cAAc,EAE7C,GAAI,CAAC,CAAA,EAAA,EAAA,gBAAgB,AAAhB,IACH,CADuB,MAChB,EAGT,GAAI,CACF,IAAM,EAAQ,CAAA,EAAA,EAAA,cAAA,AAAc,IAC5B,GAAI,CAAC,EAAO,OAAO,EAGnB,OADA,MAAM,EAAM,GAAG,CAAC,EAAK,KAAK,SAAS,CAAC,GAAQ,CAAE,GAAI,CAAW,GACtD,EACT,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,mBAAoB,IAC3B,CACT,CACF,CAKO,eAAe,EAAY,CAAW,EAC3C,GAAI,CAAC,CAAA,EAAA,EAAA,gBAAA,AAAgB,IACnB,CADuB,MAChB,EAGT,GAAI,CACF,IAAM,EAAQ,CAAA,EAAA,EAAA,cAAA,AAAc,IAC5B,GAAI,CAAC,EAAO,OAAO,EAGnB,OADA,MAAM,EAAM,GAAG,CAAC,IACT,CACT,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,sBAAuB,IAC9B,CACT,CACF,CAKO,eAAe,EAAmB,CAAe,EACtD,GAAI,CAAC,CAAA,EAAA,EAAA,gBAAgB,AAAhB,IACH,CADuB,MAChB,EAGT,GAAI,CACF,IAAM,EAAQ,CAAA,EAAA,EAAA,cAAA,AAAc,IAC5B,GAAI,CAAC,EAAO,OAAO,EAGnB,IAAI,EAAS,EACb,EAAG,CACD,GAAM,CAAC,EAAW,EAAK,CAAG,MAAM,EAAM,IAAI,CAAC,EAAQ,CACjD,MAAO,EACP,MAAO,GACT,GACA,EAAS,SAAS,EAAqB,IAEnC,EAAK,MAAM,CAAG,GAAG,AACnB,MAAM,EAAM,GAAG,IAAI,EAEvB,OAAoB,IAAX,EAAc,AAEvB,OAAO,CACT,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,8BAA+B,IACtC,CACT,CACF,CAKO,eAAe,EACpB,CAAW,CACX,CAAyB,CACzB,EAAqB,EAAA,SAAS,CAAC,cAAc,EAG7C,IAAM,EAAS,MAAM,EAAY,GACjC,GAAe,OAAX,EAAiB,CAEnB,GAAI,AAAkB,UAAU,OAArB,EACT,GAAI,CACF,OAAO,KAAK,KAAK,CAAC,EACpB,CAAE,KAAM,CAER,CAEF,OAAO,CACT,CAGA,IAAM,EAAQ,MAAM,IAKpB,OAFA,MAAM,EAAS,EAAK,EAAO,GAEpB,CACT,CAKO,eAAe,EAAwB,CAAc,EAC1D,MAAM,EAAmB,CAAC,eAAe,EAAE,EAAO,CAAC,CAAC,CACtD,CAKO,eAAe,IACpB,MAAM,EAAmB,gBAC3B"}