{"version":3,"sources":["../../../../../../../Documents/Git/system-design/system-design-simulator/src/lib/analytics/performance-analytics.ts","../../../../../../../Documents/Git/system-design/system-design-simulator/src/lib/followup-engine.ts","../../../../../../../Documents/Git/system-design/system-design-simulator/src/lib/prompts/interviewer.ts"],"sourcesContent":["/**\n * Performance Analytics Library\n *\n * Core analytics calculations for user performance tracking.\n * Tracks score progression, identifies weak areas, and generates insights.\n */\n\nimport { prisma } from \"@/lib/prisma\";\n\n// Score dimension type for type-safe access\ntype ScoreDimension =\n  | \"requirementsClarification\"\n  | \"highLevelDesign\"\n  | \"detailedDesign\"\n  | \"scalability\"\n  | \"tradeoffs\"\n  | \"communication\";\n\n// Helper to get score value from dimension key\nfunction getScoreValue(\n  score: {\n    requirementsClarification: number;\n    highLevelDesign: number;\n    detailedDesign: number;\n    scalability: number;\n    tradeoffs: number;\n    communication: number;\n  },\n  dimension: ScoreDimension\n): number {\n  return score[dimension];\n}\n\n// Types\nexport interface ScoreDataPoint {\n  date: string;\n  overallScore: number;\n  passStatus: boolean;\n  topic: string;\n  interviewId: string;\n}\n\nexport interface DimensionMetrics {\n  avgScore: number;\n  trend: \"improving\" | \"stable\" | \"declining\";\n  isWeak: boolean; // Below 2.5\n  isStrong: boolean; // Above 3.0\n  recentScores: number[];\n}\n\nexport interface WeakArea {\n  dimension: string;\n  avgScore: number;\n  occurrences: number;\n  lastScore: number;\n  trend: \"improving\" | \"stable\" | \"declining\";\n}\n\nexport interface PerformanceMetrics {\n  overall: {\n    totalInterviews: number;\n    completedInterviews: number;\n    avgScore: number;\n    passRate: number;\n    scoreTrend: \"improving\" | \"stable\" | \"declining\";\n  };\n  dimensions: {\n    [key: string]: DimensionMetrics;\n  };\n  recentScores: ScoreDataPoint[];\n  insights: string[];\n  recommendations: string[];\n}\n\n// Dimension names mapping\nconst DIMENSION_NAMES: Record<string, string> = {\n  requirementsClarification: \"Requirements Clarification\",\n  highLevelDesign: \"High-Level Design\",\n  detailedDesign: \"Detailed Design\",\n  scalability: \"Scalability\",\n  tradeoffs: \"Trade-offs\",\n  communication: \"Communication\",\n};\n\nconst DIMENSION_KEYS = Object.keys(DIMENSION_NAMES);\n\n/**\n * Calculate trend from an array of scores (oldest to newest)\n */\nexport function calculateTrend(scores: number[]): \"improving\" | \"stable\" | \"declining\" {\n  if (scores.length < 3) return \"stable\";\n\n  // Use linear regression to determine trend\n  const n = scores.length;\n  let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;\n\n  for (let i = 0; i < n; i++) {\n    sumX += i;\n    sumY += scores[i];\n    sumXY += i * scores[i];\n    sumXX += i * i;\n  }\n\n  const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);\n\n  // Threshold for trend detection\n  if (slope > 0.1) return \"improving\";\n  if (slope < -0.1) return \"declining\";\n  return \"stable\";\n}\n\n/**\n * Get score progression over time for a user\n */\nexport async function getScoreProgression(\n  userId: string,\n  dimension?: string,\n  limit: number = 20\n): Promise<ScoreDataPoint[]> {\n  const interviews = await prisma.interview.findMany({\n    where: {\n      userId,\n      status: \"completed\",\n    },\n    orderBy: { endedAt: \"asc\" },\n    take: limit,\n    include: {\n      score: true,\n    },\n  });\n\n  return interviews\n    .filter((i) => i.score)\n    .map((interview) => ({\n      date: interview.endedAt?.toISOString() || interview.createdAt.toISOString(),\n      overallScore: dimension\n        ? getScoreValue(interview.score!, dimension as ScoreDimension)\n        : interview.score!.overallScore,\n      passStatus: interview.score!.passStatus,\n      topic: interview.topic,\n      interviewId: interview.id,\n    }));\n}\n\n/**\n * Identify weak areas for a user\n */\nexport async function identifyWeakAreas(userId: string, limit: number = 10): Promise<WeakArea[]> {\n  const interviews = await prisma.interview.findMany({\n    where: {\n      userId,\n      status: \"completed\",\n    },\n    orderBy: { endedAt: \"desc\" },\n    take: limit,\n    include: {\n      score: true,\n    },\n  });\n\n  const dimensionScores: Record<string, number[]> = {};\n\n  // Initialize arrays for each dimension\n  DIMENSION_KEYS.forEach((key) => {\n    dimensionScores[key] = [];\n  });\n\n  // Collect scores for each dimension\n  for (const interview of interviews) {\n    if (!interview.score) continue;\n\n    DIMENSION_KEYS.forEach((key) => {\n      const score = getScoreValue(interview.score!, key as ScoreDimension);\n      if (score !== undefined) {\n        dimensionScores[key].push(score);\n      }\n    });\n  }\n\n  // Calculate weak areas (avg < 2.5)\n  const weakAreas: WeakArea[] = [];\n\n  for (const [dimension, scores] of Object.entries(dimensionScores)) {\n    if (scores.length === 0) continue;\n\n    const avgScore = scores.reduce((a, b) => a + b, 0) / scores.length;\n\n    if (avgScore < 2.5) {\n      weakAreas.push({\n        dimension: DIMENSION_NAMES[dimension] || dimension,\n        avgScore: Number(avgScore.toFixed(2)),\n        occurrences: scores.filter((s) => s < 2.5).length,\n        lastScore: scores[0], // Most recent\n        trend: calculateTrend(scores.reverse()), // Oldest to newest for trend\n      });\n    }\n  }\n\n  // Sort by average score (weakest first)\n  return weakAreas.sort((a, b) => a.avgScore - b.avgScore);\n}\n\n/**\n * Generate insights based on performance metrics\n */\nexport function generateInsights(metrics: PerformanceMetrics): string[] {\n  const insights: string[] = [];\n\n  // Overall performance insights\n  if (metrics.overall.completedInterviews === 0) {\n    insights.push(\"Complete your first interview to start tracking progress!\");\n    return insights;\n  }\n\n  if (metrics.overall.avgScore >= 3.0) {\n    insights.push(\"Your overall performance is strong. You're ready for senior-level interviews.\");\n  } else if (metrics.overall.avgScore >= 2.5) {\n    insights.push(\"You're performing at a passing level. Focus on your weak areas to improve.\");\n  } else {\n    insights.push(\"Your scores indicate room for improvement. Consider more practice sessions.\");\n  }\n\n  // Pass rate insights\n  if (metrics.overall.passRate >= 80) {\n    insights.push(`Excellent pass rate of ${metrics.overall.passRate.toFixed(0)}%!`);\n  } else if (metrics.overall.passRate >= 50) {\n    insights.push(`Your pass rate is ${metrics.overall.passRate.toFixed(0)}%. Aim for consistency.`);\n  } else if (metrics.overall.completedInterviews >= 3) {\n    insights.push(`Pass rate of ${metrics.overall.passRate.toFixed(0)}% needs attention. Review fundamentals.`);\n  }\n\n  // Trend insights\n  if (metrics.overall.scoreTrend === \"improving\") {\n    insights.push(\"Your scores are trending upward. Keep up the great work!\");\n  } else if (metrics.overall.scoreTrend === \"declining\") {\n    insights.push(\"Your recent scores have declined. Consider reviewing basics.\");\n  }\n\n  // Dimension-specific insights\n  const weakDimensions = Object.entries(metrics.dimensions)\n    .filter(([, m]) => m.isWeak)\n    .map(([key]) => DIMENSION_NAMES[key] || key);\n\n  if (weakDimensions.length > 0) {\n    insights.push(`Focus areas: ${weakDimensions.join(\", \")}`);\n  }\n\n  const strongDimensions = Object.entries(metrics.dimensions)\n    .filter(([, m]) => m.isStrong)\n    .map(([key]) => DIMENSION_NAMES[key] || key);\n\n  if (strongDimensions.length > 0) {\n    insights.push(`Strong areas: ${strongDimensions.join(\", \")}`);\n  }\n\n  return insights;\n}\n\n/**\n * Generate recommendations based on performance\n */\nexport function generateRecommendations(metrics: PerformanceMetrics): string[] {\n  const recommendations: string[] = [];\n\n  if (metrics.overall.completedInterviews === 0) {\n    recommendations.push(\"Start with an easy difficulty interview to build confidence.\");\n    return recommendations;\n  }\n\n  // Weak dimension recommendations\n  const weakDimensions = Object.entries(metrics.dimensions)\n    .filter(([, m]) => m.isWeak)\n    .sort((a, b) => a[1].avgScore - b[1].avgScore);\n\n  for (const [key, dimMetrics] of weakDimensions.slice(0, 2)) {\n    const name = DIMENSION_NAMES[key] || key;\n\n    switch (key) {\n      case \"requirementsClarification\":\n        recommendations.push(\n          `Practice asking clarifying questions about scale, users, and constraints.`\n        );\n        break;\n      case \"highLevelDesign\":\n        recommendations.push(\n          `Study common system design patterns and practice drawing architecture diagrams.`\n        );\n        break;\n      case \"detailedDesign\":\n        recommendations.push(\n          `Review data modeling, API design, and dive deeper into component internals.`\n        );\n        break;\n      case \"scalability\":\n        recommendations.push(\n          `Study caching, sharding, load balancing, and horizontal scaling strategies.`\n        );\n        break;\n      case \"tradeoffs\":\n        recommendations.push(\n          `Practice discussing CAP theorem, consistency vs availability, and cost tradeoffs.`\n        );\n        break;\n      case \"communication\":\n        recommendations.push(\n          `Practice explaining your thought process clearly and structuring your responses.`\n        );\n        break;\n      default:\n        recommendations.push(`Focus on improving ${name} (current avg: ${dimMetrics.avgScore.toFixed(1)}).`);\n    }\n  }\n\n  // Interview frequency recommendation\n  if (metrics.overall.completedInterviews < 5) {\n    recommendations.push(\"Complete at least 5 interviews to establish reliable patterns.\");\n  }\n\n  // Difficulty recommendation\n  if (metrics.overall.avgScore >= 3.0 && metrics.overall.passRate >= 70) {\n    recommendations.push(\"Consider increasing difficulty to challenge yourself further.\");\n  } else if (metrics.overall.avgScore < 2.0) {\n    recommendations.push(\"Try easier interviews to build foundational knowledge.\");\n  }\n\n  return recommendations;\n}\n\n/**\n * Calculate comprehensive performance metrics for a user\n */\nexport async function calculatePerformanceMetrics(\n  userId: string,\n  limit: number = 20\n): Promise<PerformanceMetrics> {\n  // Fetch interview data\n  const [totalCount, completedInterviews] = await Promise.all([\n    prisma.interview.count({\n      where: { userId },\n    }),\n    prisma.interview.findMany({\n      where: {\n        userId,\n        status: \"completed\",\n      },\n      orderBy: { endedAt: \"desc\" },\n      take: limit,\n      include: {\n        score: true,\n      },\n    }),\n  ]);\n\n  const completedCount = completedInterviews.length;\n  const interviewsWithScores = completedInterviews.filter((i) => i.score);\n\n  // Calculate overall metrics\n  let avgScore = 0;\n  let passCount = 0;\n  const overallScores: number[] = [];\n\n  for (const interview of interviewsWithScores) {\n    avgScore += interview.score!.overallScore;\n    if (interview.score!.passStatus) passCount++;\n    overallScores.push(interview.score!.overallScore);\n  }\n\n  if (interviewsWithScores.length > 0) {\n    avgScore /= interviewsWithScores.length;\n  }\n\n  const passRate = interviewsWithScores.length > 0\n    ? (passCount / interviewsWithScores.length) * 100\n    : 0;\n\n  // Calculate dimension metrics\n  const dimensionMetrics: Record<string, DimensionMetrics> = {};\n\n  for (const key of DIMENSION_KEYS) {\n    const scores: number[] = [];\n\n    for (const interview of interviewsWithScores) {\n      const score = getScoreValue(interview.score!, key as ScoreDimension);\n      if (score !== undefined) {\n        scores.push(score);\n      }\n    }\n\n    if (scores.length > 0) {\n      const dimAvg = scores.reduce((a, b) => a + b, 0) / scores.length;\n      dimensionMetrics[key] = {\n        avgScore: Number(dimAvg.toFixed(2)),\n        trend: calculateTrend(scores.reverse()), // Oldest to newest\n        isWeak: dimAvg < 2.5,\n        isStrong: dimAvg >= 3.0,\n        recentScores: scores.slice(-5),\n      };\n    } else {\n      dimensionMetrics[key] = {\n        avgScore: 0,\n        trend: \"stable\",\n        isWeak: false,\n        isStrong: false,\n        recentScores: [],\n      };\n    }\n  }\n\n  // Build recent scores\n  const recentScores: ScoreDataPoint[] = interviewsWithScores.map((i) => ({\n    date: i.endedAt?.toISOString() || i.createdAt.toISOString(),\n    overallScore: i.score!.overallScore,\n    passStatus: i.score!.passStatus,\n    topic: i.topic,\n    interviewId: i.id,\n  }));\n\n  // Build metrics object\n  const metrics: PerformanceMetrics = {\n    overall: {\n      totalInterviews: totalCount,\n      completedInterviews: completedCount,\n      avgScore: Number(avgScore.toFixed(2)),\n      passRate: Number(passRate.toFixed(1)),\n      scoreTrend: calculateTrend(overallScores.reverse()),\n    },\n    dimensions: dimensionMetrics,\n    recentScores,\n    insights: [],\n    recommendations: [],\n  };\n\n  // Generate insights and recommendations\n  metrics.insights = generateInsights(metrics);\n  metrics.recommendations = generateRecommendations(metrics);\n\n  return metrics;\n}\n\n/**\n * Update cached user analytics after an interview\n */\nexport async function updateUserAnalyticsCache(userId: string): Promise<void> {\n  const metrics = await calculatePerformanceMetrics(userId, 50);\n\n  // Extract weak and strong dimensions\n  const weakDimensions = Object.entries(metrics.dimensions)\n    .filter(([, m]) => m.isWeak)\n    .map(([key]) => key);\n\n  const strongDimensions = Object.entries(metrics.dimensions)\n    .filter(([, m]) => m.isStrong)\n    .map(([key]) => key);\n\n  // Calculate topic stats\n  const topicInterviews = await prisma.interview.findMany({\n    where: { userId, status: \"completed\" },\n    include: { score: true },\n  });\n\n  const topicStats: Record<string, { count: number; totalScore: number; passCount: number }> = {};\n\n  for (const interview of topicInterviews) {\n    if (!interview.score) continue;\n\n    if (!topicStats[interview.topic]) {\n      topicStats[interview.topic] = { count: 0, totalScore: 0, passCount: 0 };\n    }\n\n    topicStats[interview.topic].count++;\n    topicStats[interview.topic].totalScore += interview.score.overallScore;\n    if (interview.score.passStatus) {\n      topicStats[interview.topic].passCount++;\n    }\n  }\n\n  // Convert to final format\n  const finalTopicStats: Record<string, { count: number; avgScore: number; passRate: number }> = {};\n  for (const [topic, stats] of Object.entries(topicStats)) {\n    finalTopicStats[topic] = {\n      count: stats.count,\n      avgScore: Number((stats.totalScore / stats.count).toFixed(2)),\n      passRate: Number(((stats.passCount / stats.count) * 100).toFixed(1)),\n    };\n  }\n\n  // Upsert analytics record\n  await prisma.userAnalytics.upsert({\n    where: { userId },\n    create: {\n      userId,\n      totalInterviews: metrics.overall.totalInterviews,\n      completedInterviews: metrics.overall.completedInterviews,\n      avgOverallScore: metrics.overall.avgScore,\n      passRate: metrics.overall.passRate,\n      weakDimensions: JSON.stringify(weakDimensions),\n      strongDimensions: JSON.stringify(strongDimensions),\n      topicStats: JSON.stringify(finalTopicStats),\n      scoreTrend: metrics.overall.scoreTrend,\n      lastCalculatedAt: new Date(),\n    },\n    update: {\n      totalInterviews: metrics.overall.totalInterviews,\n      completedInterviews: metrics.overall.completedInterviews,\n      avgOverallScore: metrics.overall.avgScore,\n      passRate: metrics.overall.passRate,\n      weakDimensions: JSON.stringify(weakDimensions),\n      strongDimensions: JSON.stringify(strongDimensions),\n      topicStats: JSON.stringify(finalTopicStats),\n      scoreTrend: metrics.overall.scoreTrend,\n      lastCalculatedAt: new Date(),\n    },\n  });\n}\n\n/**\n * Get performance category based on average score\n */\nexport function getPerformanceCategory(\n  avgScore: number\n): \"struggling\" | \"developing\" | \"proficient\" | \"excelling\" {\n  if (avgScore < 2.0) return \"struggling\";\n  if (avgScore < 2.5) return \"developing\";\n  if (avgScore < 3.0) return \"proficient\";\n  return \"excelling\";\n}\n","/**\n * Follow-up Questions Engine\n *\n * Generates follow-up questions based on past weak points.\n * AI remembers previous attempts and asks about past weak points.\n */\n\nimport { prisma } from \"@/lib/prisma\";\nimport { identifyWeakAreas, calculatePerformanceMetrics } from \"./analytics/performance-analytics\";\n\n// Score dimension type for type-safe access\ntype ScoreDimension =\n  | \"requirementsClarification\"\n  | \"highLevelDesign\"\n  | \"detailedDesign\"\n  | \"scalability\"\n  | \"tradeoffs\"\n  | \"communication\";\n\n// Helper to get score value from dimension key\nfunction getScoreValue(\n  score: {\n    requirementsClarification: number;\n    highLevelDesign: number;\n    detailedDesign: number;\n    scalability: number;\n    tradeoffs: number;\n    communication: number;\n  },\n  dimension: ScoreDimension\n): number {\n  return score[dimension];\n}\n\n// Types\nexport interface WeakPoint {\n  dimension: string;\n  dimensionKey: string;\n  topic: string;\n  concept: string;\n  lastScore: number;\n  occurrences: number;\n  trend: \"improving\" | \"stable\" | \"declining\";\n}\n\nexport interface FollowUpContext {\n  weakPoints: WeakPoint[];\n  topicsToReinforce: string[];\n  conceptsToProbe: string[];\n  adaptedDifficulty: \"easier\" | \"standard\" | \"harder\";\n  hasHistory: boolean;\n  totalPastInterviews: number;\n}\n\n// Dimension to concept mapping\nconst DIMENSION_CONCEPTS: Record<string, string[]> = {\n  requirementsClarification: [\n    \"scale estimation (DAU, QPS)\",\n    \"functional vs non-functional requirements\",\n    \"latency and availability requirements\",\n    \"data consistency requirements\",\n    \"feature prioritization\",\n  ],\n  highLevelDesign: [\n    \"API design and endpoints\",\n    \"component architecture\",\n    \"database selection\",\n    \"data flow between components\",\n    \"service boundaries\",\n  ],\n  detailedDesign: [\n    \"data models and schemas\",\n    \"algorithm choices\",\n    \"caching strategies\",\n    \"protocol selection\",\n    \"failure handling\",\n  ],\n  scalability: [\n    \"horizontal vs vertical scaling\",\n    \"database sharding\",\n    \"load balancing strategies\",\n    \"caching layers\",\n    \"CDN usage\",\n  ],\n  tradeoffs: [\n    \"CAP theorem implications\",\n    \"consistency vs availability\",\n    \"cost vs performance\",\n    \"latency vs throughput\",\n    \"complexity vs maintainability\",\n  ],\n  communication: [\n    \"structured thinking\",\n    \"clear explanations\",\n    \"diagram usage\",\n    \"time management\",\n    \"handling clarifications\",\n  ],\n};\n\n// Dimension names\nconst DIMENSION_NAMES: Record<string, string> = {\n  requirementsClarification: \"Requirements Clarification\",\n  highLevelDesign: \"High-Level Design\",\n  detailedDesign: \"Detailed Design\",\n  scalability: \"Scalability\",\n  tradeoffs: \"Trade-offs\",\n  communication: \"Communication\",\n};\n\n/**\n * Get weak points for a user based on past interview performance\n */\nexport async function getWeakPointsForUser(\n  userId: string,\n  limit: number = 10\n): Promise<WeakPoint[]> {\n  const weakAreas = await identifyWeakAreas(userId, limit);\n\n  // Convert weak areas to weak points with concepts\n  const weakPoints: WeakPoint[] = [];\n\n  for (const area of weakAreas) {\n    // Find the dimension key from the display name\n    const dimensionKey = Object.entries(DIMENSION_NAMES).find(\n      ([, name]) => name === area.dimension\n    )?.[0];\n\n    if (!dimensionKey) continue;\n\n    const concepts = DIMENSION_CONCEPTS[dimensionKey] || [];\n\n    // Select 1-2 relevant concepts to probe based on the weak area\n    const conceptsToProbe = concepts.slice(0, 2);\n\n    weakPoints.push({\n      dimension: area.dimension,\n      dimensionKey,\n      topic: \"\", // Will be filled with specific topic if available\n      concept: conceptsToProbe.join(\", \"),\n      lastScore: area.lastScore,\n      occurrences: area.occurrences,\n      trend: area.trend,\n    });\n  }\n\n  return weakPoints;\n}\n\n/**\n * Build follow-up context for a new interview\n */\nexport async function buildFollowUpContext(\n  userId: string,\n  currentTopic: string\n): Promise<FollowUpContext> {\n  // Get performance metrics\n  const metrics = await calculatePerformanceMetrics(userId, 15);\n\n  // Get weak points\n  const weakPoints = await getWeakPointsForUser(userId, 10);\n\n  // Get topics that need reinforcement\n  const topicInterviews = await prisma.interview.findMany({\n    where: {\n      userId,\n      status: \"completed\",\n    },\n    include: { score: true },\n    orderBy: { endedAt: \"desc\" },\n    take: 20,\n  });\n\n  // Find topics with low pass rates\n  const topicStats: Record<string, { total: number; passed: number }> = {};\n\n  for (const interview of topicInterviews) {\n    if (!interview.score) continue;\n\n    if (!topicStats[interview.topic]) {\n      topicStats[interview.topic] = { total: 0, passed: 0 };\n    }\n\n    topicStats[interview.topic].total++;\n    if (interview.score.passStatus) {\n      topicStats[interview.topic].passed++;\n    }\n  }\n\n  const topicsToReinforce = Object.entries(topicStats)\n    .filter(([, stats]) => stats.total >= 2 && stats.passed / stats.total < 0.5)\n    .map(([topic]) => topic);\n\n  // Determine concepts to probe based on weak points\n  const conceptsToProbe: string[] = [];\n\n  for (const wp of weakPoints.slice(0, 3)) {\n    const concepts = DIMENSION_CONCEPTS[wp.dimensionKey] || [];\n    conceptsToProbe.push(...concepts.slice(0, 2));\n  }\n\n  // Determine difficulty adaptation\n  let adaptedDifficulty: \"easier\" | \"standard\" | \"harder\" = \"standard\";\n\n  if (metrics.overall.avgScore < 2.0) {\n    adaptedDifficulty = \"easier\";\n  } else if (metrics.overall.avgScore >= 3.0 && metrics.overall.passRate >= 70) {\n    adaptedDifficulty = \"harder\";\n  }\n\n  return {\n    weakPoints,\n    topicsToReinforce,\n    conceptsToProbe: [...new Set(conceptsToProbe)], // Remove duplicates\n    adaptedDifficulty,\n    hasHistory: metrics.overall.completedInterviews > 0,\n    totalPastInterviews: metrics.overall.completedInterviews,\n  };\n}\n\n/**\n * Generate prompt addition for follow-up context\n */\nexport function generateFollowUpPromptAddition(context: FollowUpContext): string {\n  if (!context.hasHistory || context.weakPoints.length === 0) {\n    return \"\";\n  }\n\n  let prompt = `\n## Candidate's Past Performance Context\n\nThis candidate has completed ${context.totalPastInterviews} previous interview${context.totalPastInterviews === 1 ? \"\" : \"s\"}.\n\n### Weak Areas to Focus On\n`;\n\n  for (const wp of context.weakPoints.slice(0, 3)) {\n    prompt += `- **${wp.dimension}** (avg score: ${wp.lastScore}/4, trend: ${wp.trend})\n  - Concepts to probe: ${wp.concept}\n`;\n  }\n\n  if (context.conceptsToProbe.length > 0) {\n    prompt += `\n### Specific Concepts to Cover\nDuring the interview, make sure to ask about:\n${context.conceptsToProbe.map((c) => `- ${c}`).join(\"\\n\")}\n`;\n  }\n\n  if (context.topicsToReinforce.length > 0) {\n    prompt += `\n### Related Topics With Low Performance\nThe candidate has struggled with these related topics: ${context.topicsToReinforce.join(\", \")}\nConsider asking questions that reinforce fundamentals from these areas.\n`;\n  }\n\n  prompt += `\n### Adaptation Instructions\n- Difficulty adaptation: ${context.adaptedDifficulty}\n${context.adaptedDifficulty === \"easier\" ? \"- Provide more hints and guidance for this candidate\" : \"\"}\n${context.adaptedDifficulty === \"harder\" ? \"- Challenge this candidate with edge cases and deeper probing\" : \"\"}\n- When the candidate answers questions related to their weak areas, probe deeper\n- Acknowledge improvement if they perform better on previously weak dimensions\n`;\n\n  return prompt;\n}\n\n/**\n * Track improvement on a specific concept (for future enhancement)\n */\nexport async function trackConceptImprovement(\n  userId: string,\n  interviewId: string,\n  dimension: string,\n  newScore: number\n): Promise<{ improved: boolean; previousScore: number | null }> {\n  // Get the previous score for this dimension\n  const previousInterviews = await prisma.interview.findMany({\n    where: {\n      userId,\n      status: \"completed\",\n      id: { not: interviewId },\n    },\n    include: { score: true },\n    orderBy: { endedAt: \"desc\" },\n    take: 5,\n  });\n\n  const previousScores = previousInterviews\n    .filter((i) => i.score)\n    .map((i) => getScoreValue(i.score!, dimension as ScoreDimension))\n    .filter((s) => s !== undefined);\n\n  if (previousScores.length === 0) {\n    return { improved: false, previousScore: null };\n  }\n\n  const previousAvg = previousScores.reduce((a, b) => a + b, 0) / previousScores.length;\n\n  return {\n    improved: newScore > previousAvg,\n    previousScore: Number(previousAvg.toFixed(2)),\n  };\n}\n","import { PersonalitySettings, AdaptedPersonality } from \"../ai-personality-adapter\";\nimport { FollowUpContext, generateFollowUpPromptAddition } from \"../followup-engine\";\n\nexport const INTERVIEW_PHASES = [\n  {\n    id: \"requirements\",\n    name: \"Requirements Clarification\",\n    duration: 8, // minutes\n    startTime: 45,\n    endTime: 37,\n    description: \"Understand the problem scope, scale, and constraints\",\n    keyPoints: [\n      \"Clarify functional requirements\",\n      \"Understand scale (users, QPS, data size)\",\n      \"Identify non-functional requirements (latency, availability)\",\n      \"Prioritize features\",\n    ],\n  },\n  {\n    id: \"high-level\",\n    name: \"High-Level Design\",\n    duration: 12,\n    startTime: 37,\n    endTime: 25,\n    description: \"Design the overall system architecture\",\n    keyPoints: [\n      \"Draw core components\",\n      \"Define APIs\",\n      \"Explain data flow\",\n      \"Choose databases and storage\",\n    ],\n  },\n  {\n    id: \"deep-dive\",\n    name: \"Deep Dive\",\n    duration: 12,\n    startTime: 25,\n    endTime: 13,\n    description: \"Explore critical components in detail\",\n    keyPoints: [\n      \"Data models and schemas\",\n      \"Algorithms and protocols\",\n      \"Failure handling\",\n      \"Edge cases\",\n    ],\n  },\n  {\n    id: \"scalability\",\n    name: \"Scalability & Trade-offs\",\n    duration: 10,\n    startTime: 13,\n    endTime: 3,\n    description: \"Discuss scaling and architectural decisions\",\n    keyPoints: [\n      \"Handle 10x-100x growth\",\n      \"Caching strategies\",\n      \"CAP theorem implications\",\n      \"Cost vs performance\",\n    ],\n  },\n  {\n    id: \"wrapup\",\n    name: \"Wrap-up\",\n    duration: 3,\n    startTime: 3,\n    endTime: 0,\n    description: \"Final questions and summary\",\n    keyPoints: [\n      \"Address remaining concerns\",\n      \"Candidate questions\",\n      \"Summary of design\",\n    ],\n  },\n] as const;\n\nexport type InterviewPhase = typeof INTERVIEW_PHASES[number][\"id\"];\n\nexport const INTERVIEWER_SYSTEM_PROMPT = `You are Bobby, a friendly and experienced FAANG system design interviewer with 10+ years of experience at companies like Google, Meta, Amazon, Netflix, and Uber. Your role is to conduct a realistic 45-minute system design interview.\n\n## Your Personality as Bobby\n- Be warm, encouraging, and professional\n- Use a conversational tone while maintaining technical rigor\n- Occasionally use phrases like \"Great point!\", \"That's interesting...\", \"I like that approach\"\n- Introduce yourself as Bobby at the start of the interview\n\n## Interview Structure (45 minutes total)\n\n### Phase 1: Requirements Clarification (Minutes 45:00 - 37:00) [8 min]\n- Ask about scale (DAU, requests/sec, data size)\n- Clarify functional vs non-functional requirements\n- Understand use cases and priorities\n- Key questions:\n  * \"What's the expected scale? DAU, requests per second?\"\n  * \"What are the most critical features we need to support?\"\n  * \"What are our latency requirements?\"\n  * \"Do we need strong consistency or is eventual consistency okay?\"\n\n### Phase 2: High-Level Design (Minutes 37:00 - 25:00) [12 min]\n- Guide them to draw core components\n- Discuss API design\n- Cover data flow between components\n- Key questions:\n  * \"Can you walk me through the high-level architecture?\"\n  * \"What databases would you use and why?\"\n  * \"How would data flow from client to storage?\"\n\n### Phase 3: Deep Dive (Minutes 25:00 - 13:00) [12 min]\n- Pick 2-3 critical components to explore in detail\n- Ask about data models, algorithms, protocols\n- Discuss failure scenarios and edge cases\n- Key questions:\n  * \"Let's dive deeper into [component]. How would you implement it?\"\n  * \"What happens if [failure scenario]?\"\n  * \"How would you handle [edge case]?\"\n\n### Phase 4: Scalability & Trade-offs (Minutes 13:00 - 3:00) [10 min]\n- How does it handle 10x, 100x scale?\n- CAP theorem implications\n- Cost vs performance tradeoffs\n- Key questions:\n  * \"How would this design change if we had 100x the users?\"\n  * \"What are the bottlenecks in this design?\"\n  * \"What trade-offs are you making here?\"\n\n### Phase 5: Wrap-up (Minutes 3:00 - 0:00) [3 min]\n- Address any remaining concerns\n- Allow candidate to ask questions\n- Summarize the design\n\n## Bobby's Interview Style\n\n1. **Be conversational and supportive** - Guide the candidate through each phase while being encouraging\n2. **Ask probing questions** - Push candidates to think deeper with genuine curiosity\n3. **Focus on tradeoffs** - There's no single right answer; evaluate reasoning\n4. **Manage time** - Gently transition between phases to cover all areas\n5. **Adapt to responses** - If they struggle, provide hints; if they excel, go deeper\n6. **Stay positive** - Even when challenging decisions, do so constructively\n\n## Phase Transition Signals\n\nWhen you determine it's time to move to the next phase, include this marker in your response:\n[PHASE_TRANSITION: <next_phase_id>]\n\nFor example: [PHASE_TRANSITION: high-level]\n\nOnly use these phase IDs: requirements, high-level, deep-dive, scalability, wrapup\n\n## Important Rules\n\n- DO NOT give away answers - guide them with questions\n- DO NOT be overly positive - be professional and objective\n- DO challenge their decisions - \"Why not use X instead?\"\n- DO acknowledge good points - \"That's a good consideration\"\n- DO redirect if they go off track - \"Let's focus on the core flow first\"\n- DO manage time - transition phases appropriately\n- KEEP responses concise - 2-4 sentences, then ask 1-2 questions\n\n## CRITICAL: Phase Boundary Enforcement\n\n**YOU MUST STRICTLY STAY WITHIN THE CURRENT PHASE. DO NOT JUMP AHEAD OR GO BACKWARDS.**\n\n- **In Requirements Phase (45:00-37:00)**: ONLY ask about scale, functional/non-functional requirements, priorities. DO NOT ask about architecture, databases, or implementation details yet.\n- **In High-Level Design Phase (37:00-25:00)**: ONLY ask about overall architecture, main components, API design, and data flow. DO NOT dive into implementation details, algorithms, or schemas yet.\n- **In Deep Dive Phase (25:00-13:00)**: NOW you can ask about data models, algorithms, protocols, and implementation details. DO NOT ask about scalability or caching yet.\n- **In Scalability Phase (13:00-3:00)**: NOW you can ask about scaling strategies, caching, sharding, load balancing, and performance optimization.\n- **In Wrap-up Phase (3:00-0:00)**: Summarize, answer candidate questions, discuss any remaining concerns.\n\n**If the candidate jumps ahead** (e.g., talks about caching in requirements phase), acknowledge briefly but redirect: \"That's an interesting point about caching, but let's first clarify the requirements. We'll discuss optimization strategies later.\"\n\n**If the candidate is stuck**, provide hints ONLY related to the current phase. Don't hint at future phases.\n\n## Response Format\n\nKeep responses focused. React to their answer, provide brief feedback, then ask the next question. If transitioning phases, acknowledge the transition naturally.`;\n\nexport const getInterviewPrompt = (topic: string, difficulty: string) => {\n  const difficultyGuide = {\n    easy: \"Be more guiding and provide more hints. Focus on basic concepts. Allow more time for explanations.\",\n    medium: \"Balance between guidance and challenge. Standard FAANG interview depth.\",\n    hard: \"Be more challenging. Ask about edge cases, failure modes, and push for optimal solutions. Expect quick, precise answers.\",\n  };\n\n  return `${INTERVIEWER_SYSTEM_PROMPT}\n\n## Current Interview\n\n**Topic:** ${topic}\n**Difficulty:** ${difficulty}\n**Approach:** ${difficultyGuide[difficulty as keyof typeof difficultyGuide]}\n\nBegin the interview now. Introduce yourself as Bobby, briefly introduce the problem, and start with requirements clarification. Ask what clarifying questions they have about the system.`;\n};\n\nexport const PHASE_ANALYSIS_PROMPT = `You are analyzing a specific phase of a system design interview. Evaluate the candidate's performance in this phase only.\n\n## CRITICAL EVALUATION RULES\n\n**IMPORTANT: You MUST evaluate based ONLY on what the USER (candidate) actually said. Do NOT give credit for things the ASSISTANT (interviewer) mentioned.**\n\n1. **If the candidate provided NO responses or only said \"hello\", \"ok\", \"yes\" - score MUST be 1**\n2. **If the candidate gave vague/incomplete answers - score should be 1-2**\n3. **Only give scores of 3-4 if candidate demonstrated clear technical knowledge**\n\n## Phase Being Evaluated: {{PHASE_NAME}}\n\n## Scoring Scale (1-4)\n- 4 (Excellent): Candidate provided detailed, expert-level technical responses\n- 3 (Good): Candidate showed solid understanding through their explanations\n- 2 (Needs Work): Candidate gave partial/vague answers\n- 1 (Poor): Candidate did not provide meaningful technical responses\n\n## Evaluation Criteria for {{PHASE_NAME}}:\n{{PHASE_CRITERIA}}\n\n**If the candidate did not address these criteria in their responses, the score is 1.**\n\n## Response Format\nReturn ONLY valid JSON:\n{\n  \"phase\": \"{{PHASE_ID}}\",\n  \"score\": <1-4>,\n  \"summary\": \"<2-3 sentence evaluation - be honest if candidate didn't respond>\",\n  \"strengths\": [\"<strength 1>\", \"<strength 2>\"],\n  \"improvements\": [\"<area 1>\", \"<area 2>\"],\n  \"keyObservations\": [\"<observation 1>\", \"<observation 2>\"]\n}`;\n\nexport const getPhaseAnalysisPrompt = (phaseId: string, phaseName: string) => {\n  const phaseCriteria: Record<string, string> = {\n    requirements: `\n- Did they ask about scale (users, QPS, data volume)?\n- Did they clarify functional requirements?\n- Did they identify non-functional requirements (latency, availability, consistency)?\n- Did they prioritize features appropriately?\n- Did they ask about constraints and edge cases?`,\n    \"high-level\": `\n- Is the architecture sound and complete?\n- Are components well-defined with clear responsibilities?\n- Is the API design reasonable?\n- Did they choose appropriate databases/storage?\n- Is the data flow logical and efficient?`,\n    \"deep-dive\": `\n- Can they explain component internals?\n- Do they understand data models and schemas?\n- Did they address failure scenarios?\n- Did they consider edge cases?\n- Do they know relevant algorithms/protocols?`,\n    scalability: `\n- Do they understand horizontal vs vertical scaling?\n- Did they propose caching strategies?\n- Did they discuss sharding/partitioning?\n- Did they address load balancing?\n- Can they reason about 10x-100x growth?`,\n    wrapup: `\n- Did they summarize the design clearly?\n- Did they acknowledge trade-offs made?\n- Were they open to feedback?\n- Did they ask thoughtful questions?`,\n  };\n\n  return PHASE_ANALYSIS_PROMPT\n    .replace(/{{PHASE_NAME}}/g, phaseName)\n    .replace(/{{PHASE_ID}}/g, phaseId)\n    .replace(/{{PHASE_CRITERIA}}/g, phaseCriteria[phaseId] || \"\");\n};\n\n/**\n * Get personalized interview prompt with personality adaptation and follow-up context\n */\nexport const getPersonalizedInterviewPrompt = (\n  topic: string,\n  difficulty: string,\n  personality: AdaptedPersonality,\n  followUpContext?: FollowUpContext\n): string => {\n  const difficultyGuide = {\n    easy: \"Be more guiding and provide more hints. Focus on basic concepts. Allow more time for explanations.\",\n    medium: \"Balance between guidance and challenge. Standard FAANG interview depth.\",\n    hard: \"Be more challenging. Ask about edge cases, failure modes, and push for optimal solutions. Expect quick, precise answers.\",\n  };\n\n  // Build the follow-up context section\n  const followUpSection = followUpContext\n    ? generateFollowUpPromptAddition(followUpContext)\n    : \"\";\n\n  return `${INTERVIEWER_SYSTEM_PROMPT}\n\n${personality.promptModifications}\n${followUpSection}\n## Current Interview\n\n**Topic:** ${topic}\n**Difficulty:** ${difficulty}\n**Approach:** ${difficultyGuide[difficulty as keyof typeof difficultyGuide] || difficultyGuide.medium}\n\nBegin the interview now. Introduce yourself as Bobby, briefly introduce the problem, and start with requirements clarification. Ask what clarifying questions they have about the system.`;\n};\n\nexport const SCORING_PROMPT = `You are evaluating a complete 45-minute system design interview. Based on the entire conversation, give a final comprehensive evaluation.\n\n## CRITICAL EVALUATION RULES\n\n**IMPORTANT: You MUST evaluate based ONLY on what the USER (candidate) actually said. Do NOT give credit for things the ASSISTANT (interviewer) mentioned.**\n\n1. **If the candidate provided NO substantive responses or only said things like \"hello\", \"ok\", \"yes\" without any technical content, ALL dimension scores MUST be 1.**\n2. **If the candidate gave only brief/incomplete answers, scores should be 1-2.**\n3. **Only give scores of 3-4 if the candidate demonstrated clear technical knowledge through their own explanations.**\n4. **Count the actual technical responses from the USER. Short acknowledgments don't count as responses.**\n\n## Scoring Scale\n- 4 (Strong Hire): Exceeds expectations, demonstrates expertise with detailed technical explanations\n- 3 (Hire): Meets expectations, solid understanding shown through their responses\n- 2 (Lean No Hire): Below expectations, only partial/vague answers provided\n- 1 (No Hire): Does not meet basic requirements - no meaningful technical responses given\n\n## Dimensions to Evaluate\n\n1. **Requirements Clarification (10%)**\n   - Did the CANDIDATE ask about scale, users, data size?\n   - Did the CANDIDATE clarify functional vs non-functional requirements?\n   - If the candidate didn't ask clarifying questions, score is 1.\n\n2. **High-Level Design (20%)**\n   - Did the CANDIDATE describe an architecture?\n   - Did the CANDIDATE explain components and their responsibilities?\n   - If the candidate didn't propose any design, score is 1.\n\n3. **Detailed Design (15%)**\n   - Did the CANDIDATE explain component internals?\n   - Did the CANDIDATE discuss data models and algorithms?\n   - If the candidate didn't go into any details, score is 1.\n\n4. **Scalability (20%)**\n   - Did the CANDIDATE discuss scaling strategies?\n   - Did the CANDIDATE propose caching, sharding, load balancing?\n   - If the candidate didn't address scalability, score is 1.\n\n5. **Tradeoffs (25%)**\n   - Did the CANDIDATE reason about tradeoffs?\n   - Did the CANDIDATE compare alternatives?\n   - If the candidate didn't discuss any tradeoffs, score is 1.\n\n6. **Communication (10%)**\n   - Did the CANDIDATE communicate clearly?\n   - If the candidate barely spoke, score is 1.\n\n## Response Format\n\nReturn a JSON object with:\n{\n  \"candidateResponseCount\": <number of substantive technical responses from the user>,\n  \"requirementsClarification\": <1-4>,\n  \"highLevelDesign\": <1-4>,\n  \"detailedDesign\": <1-4>,\n  \"scalability\": <1-4>,\n  \"tradeoffs\": <1-4>,\n  \"communication\": <1-4>,\n  \"overallScore\": <weighted average>,\n  \"passStatus\": <true ONLY if average >= 2.5 AND no dimension below 2 AND tradeoffs >= 3 AND candidateResponseCount >= 5>,\n  \"feedback\": {\n    \"requirementsClarification\": \"<specific feedback based on what candidate said>\",\n    \"highLevelDesign\": \"<specific feedback based on what candidate said>\",\n    \"detailedDesign\": \"<specific feedback based on what candidate said>\",\n    \"scalability\": \"<specific feedback based on what candidate said>\",\n    \"tradeoffs\": \"<specific feedback based on what candidate said>\",\n    \"communication\": \"<specific feedback based on what candidate said>\",\n    \"overallFeedback\": \"<2-3 sentence summary - be honest if candidate didn't participate>\",\n    \"strengths\": [\"<strength 1>\", \"<strength 2>\"],\n    \"improvements\": [\"<improvement 1>\", \"<improvement 2>\"]\n  }\n}\n\nReturn ONLY valid JSON.`;\n"],"names":[],"mappings":"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"}