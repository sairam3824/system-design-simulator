// Prisma schema for AI System Design Simulator
generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String?
  avatar        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  profile       Profile?
  resumes       Resume[]
  interviews    Interview[]
  analytics     UserAnalytics?
  codingChallenges CodingChallenge[]
  codingTests     CodingTest[]
}

model Profile {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  bio             String?
  yearsExperience Int?
  skills          String   @default("[]") // JSON array stored as string
  targetCompanies String   @default("[]") // JSON array stored as string
  targetRole      String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Resume {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  fileName    String
  content     String   // Full text content of resume
  analysis    String?  // JSON object with AI analysis
  filePath    String?  // Local path to the stored resume file


  // ATS Score Data
  atsScore    Int?     // Total ATS score (0-100)
  atsBreakdown String? // JSON: { contactInfo, structure, experience, keywords, impact }
  atsFeedback String?  // JSON array of feedback strings
  keywords    String?  // JSON array of extracted keywords
  softSkills  String?  // JSON array of soft skills
  predictedRoles String? // JSON array of predicted job roles

  uploadedAt  DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Interview {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  topic       String    // e.g., "Design Twitter", "Design Uber"
  difficulty  String    @default("medium") // easy, medium, hard
  status      String    @default("pending") // pending, in_progress, completed

  startedAt   DateTime?
  endedAt     DateTime?
  createdAt   DateTime  @default(now())

  // Time tracking for phases
  phaseDurations   String?  // JSON: { requirements: 480, highLevel: 720 } in seconds
  phaseTransitions String?  // JSON: [{ phase: "requirements", startedAt: ISO, endedAt: ISO }]

  messages    Message[]
  score       Score?

  @@index([userId, status, endedAt])
}

model Message {
  id          String    @id @default(cuid())
  interviewId String
  interview   Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  role        String    // user, assistant, system
  content     String

  timestamp   DateTime  @default(now())
}

model Score {
  id                      String    @id @default(cuid())
  interviewId             String    @unique
  interview               Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  // 6 Industry-Standard FAANG Evaluation Dimensions (1-4 scale)
  requirementsClarification Int     @default(0)
  highLevelDesign           Int     @default(0)
  detailedDesign            Int     @default(0)
  scalability               Int     @default(0)
  tradeoffs                 Int     @default(0)
  communication             Int     @default(0)

  // Calculated fields
  overallScore              Float   @default(0) // Weighted average
  passStatus                Boolean @default(false)

  // Detailed feedback as JSON
  feedback                  String  @default("{}") // JSON with per-dimension comments

  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
}

// Cached analytics for user performance tracking
model UserAnalytics {
  id                  String   @id @default(cuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Cached aggregates (updated after each interview)
  totalInterviews     Int      @default(0)
  completedInterviews Int      @default(0)
  avgOverallScore     Float?
  passRate            Float?

  // Weak/strong areas tracking
  weakDimensions      String   @default("[]")  // JSON array: ["scalability", "tradeoffs"]
  strongDimensions    String   @default("[]")  // JSON array: ["communication", "requirements"]

  // Topic performance
  topicStats          String   @default("{}")  // JSON: { "Design Twitter": { count: 5, avgScore: 2.8 } }

  // Trend data
  scoreTrend          String   @default("stable") // "improving" | "stable" | "declining"
  lastCalculatedAt    DateTime @default(now())

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

// ==================== CODING CHALLENGE MODELS ====================

// Predefined problem bank
model CodingProblem {
  id              String   @id @default(cuid())
  title           String
  description     String
  difficulty      String   // easy, medium, hard
  category        String   // arrays, strings, dp, graphs, trees, etc.
  companies       String   @default("[]")  // JSON array of company names
  constraints     String   @default("[]")  // JSON array
  examples        String   @default("[]")  // JSON [{input, output, explanation}]
  testCases       String   @default("[]")  // JSON [{input, expectedOutput, isHidden}]
  solutionApproaches String @default("[]") // JSON array
  starterCode     String   @default("{}")  // JSON {python: "...", java: "..."}
  timeLimit       Int      @default(45)    // minutes
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  challenges      CodingChallenge[]

  @@index([difficulty, category])
}

// User's coding challenge instance
model CodingChallenge {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  problemId       String?
  problem         CodingProblem? @relation(fields: [problemId], references: [id])
  testId          String?
  test            CodingTest?    @relation(fields: [testId], references: [id], onDelete: Cascade)
  title           String
  description     String
  difficulty      String
  category        String
  company         String?
  language        String   // python, java, javascript, cpp, c, csharp, go
  visibleTests    String   @default("[]")
  hiddenTests     String   @default("[]")
  timeLimit       Int      @default(45)
  status          String   @default("pending") // pending, in_progress, completed
  startedAt       DateTime?
  endedAt         DateTime?
  starterCode     String?
  finalCode       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  submissions     ChallengeSubmission[]
  score           ChallengeScore?

  @@index([userId, status])
}

// Code submission for evaluation
model ChallengeSubmission {
  id              String   @id @default(cuid())
  challengeId     String
  challenge       CodingChallenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  code            String
  language        String
  submittedAt     DateTime @default(now())
  evaluation      String?
  testResults     String?
  isValid         Boolean  @default(false)
  errorMessage    String?

  @@index([challengeId])
}

// Final score for coding challenge
model ChallengeScore {
  id              String   @id @default(cuid())
  challengeId     String   @unique
  challenge       CodingChallenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  correctness     Float
  efficiency      Float
  codeQuality     Float
  edgeCases       Float
  overallScore    Float
  passStatus      Boolean
  feedback        String
  suggestedApproach String?
  complexityAnalysis String?
  createdAt       DateTime @default(now())
}

// ==================== CODING TEST MODELS ====================

model CodingTest {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  challenges  CodingChallenge[]
  status      String    @default("pending") // pending, in_progress, completed
  startedAt   DateTime?
  endedAt     DateTime?
  timeLimit   Int       // Total minutes for all questions
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

